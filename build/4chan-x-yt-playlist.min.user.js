// ==UserScript==
// @name        4chan X - YouTube Playlist
// @description Wraps all YouTube videos inside a thread into a playlist
// @namespace   4chan-X-yt-playlist
// @version     2.1.0
// @include     https://boards.4chan.org/*/thread/*
// @include     https://warosu.org/*/thread/*
// @require     https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-svg-core@1.2.35/index.min.js
// @run-at      document-start
// @grant       GM_setValue
// @grant       GM_getValue
// ==/UserScript==
class e{constructor(){switch(this.size=[0,0],this.cursorPos=[0,0],this.header=[0,0,!0,!1],document.body.insertAdjacentHTML("beforeend",'<div id="playlist-embed" class="dialog hide"><div><ul class="tabs"></ul><div class="move"></div><a class="jump" href="javascript:;" title="Jump to post">→</a><a class="close" href="javascript:;" title="Close">×</a></div><div id="playlist"></div></div>'),location.hostname){case"boards.4chan.org":this.setPos(GM_getValue("4chan Dialog Coordinates",["10%","5%",null,null]));const e=document.getElementById("shortcut-qr");if(!e)throw new Error("Unable to append toggle button.");e.insertAdjacentHTML("beforebegin",'<span id="shortcut-playlist" class="shortcut brackets-wrap"><a id="playlist-toggle" class="disabled" title="Toggle YouTube playlist" href="javascript:;"><svg xmlns="http://www.w3.org/2000/svg" class="icon" aria-hidden="true" focusable="false" viewBox="0 0 512 512">\x3c!--!Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--\x3e<path fill="currentColor" d="M464 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zm0 394c0 3.3-2.7 6-6 6H54c-3.3 0-6-2.7-6-6V192h416v234z"/></svg></a></span>');break;case"warosu.org":this.setPos(GM_getValue("Warosu Dialog Coordinates",["10%","5%",null,null]));const t=[...document.body.childNodes].find((e=>3===e.nodeType&&"DIV"===e.nextElementSibling?.tagName));if(!t?.nextElementSibling)throw new Error("Unable to append toggle link.");t.nextElementSibling.insertAdjacentHTML("beforebegin",'[ <a id="playlist-toggle" href="javascript:;" title="Toggle YouTube playlist">playlist</a> ]')}}get node(){return document.getElementById("playlist-embed")}get toggle(){return document.getElementById("playlist-toggle")}open(){this.node&&this.toggle&&(this.node.classList.remove("hide"),this.toggle.classList.remove("disabled"))}close(){this.node&&this.toggle&&(this.node.classList.add("hide"),this.toggle.classList.add("disabled"))}updateTabs(e){const t=this.node?.querySelector("ul");if(!t)return console.error("No <ul> present in dialog.");for(;t?.lastChild;)t.removeChild(t.lastChild);for(let o=0;o<e;o++)t.insertAdjacentHTML("beforeend",`<li><a href="javascript:;" data-page="${o}">${o+1}</a></li>`)}setPos(e){e.forEach(((e,t)=>{if(e&&this.node)switch(t){case 0:this.node.style.top=e;break;case 1:this.node.style.right=e;break;case 2:this.node.style.bottom=e;break;case 3:this.node.style.left=e}}))}}const t=new class{constructor(){this.checking=!1,this.mutated=!1,this.playing=!1,this.failed=!1,this.posts={},this.dialog=null,this.player=null,this.track="",this.regex=/(?:https?:\/\/)?(?:www\.)?youtu(?:\.be\/|be.com\/\S*?(?:watch|embed)(?:(?:(?=\/[-a-zA-Z0-9_]{11,}(?!\S))\/)|(?:\S*?v=|v\/)))([-a-zA-Z0-9_]{11,})/g,document.addEventListener("DOMContentLoaded",(async()=>{this.dialog=new e,this.dialog.toggle?.addEventListener("click",(()=>{if(this.dialog&&!this.checking&&!this.isEmpty())return this.player?void(this.dialog.node?.classList.contains("hide")?this.dialog.open():this.dialog.close()):this.initAPI()})),this.checking=!0;const t=await async function(){switch(location.hostname){case"boards.4chan.org":const[e,t]=window.location.pathname.slice(1).split("/thread/"),o=await fetch("https://a.4cdn.org/"+e+"/thread/"+t+".json"),{posts:a}=await o.json();return a.map((e=>[e.no.toString(),e.com||""]));case"warosu.org":return[...document.querySelectorAll(".comment blockquote")].map((e=>[e.parentElement?.id.slice(1)??"",e.innerHTML]));default:return console.error("This script isn't compatible with this image board."),[]}}();if(t.length<1)throw new Error("No post was found.");this.parsePosts(t).finally((()=>console.log(this.posts)))}))}async parsePosts(e){const t=e.reduce(((e,t)=>{const o=t[1].replace(/<wbr>/g,""),a=Array.from(new Set([...o.matchAll(this.regex)].map((e=>e[1]))));return a.length>0&&e.push([t[0],a]),e}),[]);if(t.length<1)return Promise.reject(0);const o=t.map((async e=>Promise.allSettled(e[1].map((e=>this.checkLink(e)))).then((t=>[e[0],t.reduce(((e,t)=>("fulfilled"===t.status&&e.push(t.value),e)),[])]))));return new Promise((e=>{Promise.allSettled(o).then((e=>e.reduce(((e,t)=>("fulfilled"===t.status&&e.push(t.value),e)),[]))).then((t=>{for(const e of t)this.posts[e[0]]=e[1];this.checking=!1,e(t.length)}))}))}async checkLink(e){return fetch("https://www.youtube.com/oembed?url=https://youtu.be/"+e+"&format=json",{method:"HEAD"}).then((t=>[e,t.ok]))}initAPI(){if(this.failed)return t();if(this.player)return;const e=document.createElement("script");function t(){document.dispatchEvent(new CustomEvent("CreateNotification",{detail:{type:"error",content:"Unable to load YouTube Iframe API.\nPress F12 and follow the instructions in the console."}})),console.info("Unable to load YouTube Iframe API\n\n4chanX's Settings > Advanced > Javascript Whitelist\n\n  https://www.youtube.com/iframe_api\n  https://www.youtube.com/s/player/\n\nFilters in your AdBlock extension\n\n  @@||www.youtube.com/iframe_api$script,domain=4chan.org\n  @@||www.youtube.com/s/player/*$script,domain=4chan.org\n")}e.src="https://www.youtube.com/iframe_api",document.head.appendChild(e),e.onerror=()=>{t(),this.failed=!0}}updatePlayer(){if(!this.player)return;const e=this.toPages(),t=e.findIndex((e=>e.includes(this.track)));if(t>-1){const o=e[t].indexOf(this.track),a=this.player.getDuration(),s=this.player.getCurrentTime(),n=s===a&&a>0,i=199===o,l=i&&n&&t<e.length-1?t+1:t,d=!i&&n?o+1:o;if(this.playing)this.player.loadPlaylist(e[l],d),console.debug("loadPlaylist()");else{const t=s<a?s:void 0;this.player.cuePlaylist(e[l],d,t),console.debug("cuePlaylist()")}}else console.debug("Can't find last played track in the playlist. Resetting to first page.."),this.playing?this.player.loadPlaylist(e[0]):this.player.cuePlaylist(e[0]);if(this.mutated=!1,!this.dialog)return;const o=document.getElementById("playlist-embed")?.querySelector(".tabs");o&&o.children.length!==e.length&&this.dialog.updateTabs(e.length)}toPages(){const e=[],t=Object.values(this.posts).flatMap((e=>e.reduce(((e,t)=>{const[o,a]=t;return a&&!e.includes(o)&&e.push(o),e}),[])));for(let o=0;o<t.length;o+=199){const a=t.slice(o,o+199);e.push(a)}return e}findPost(e){if(!e)return null;const t=function(e,t){for(const o in e)for(const a of e[o])if(a.includes(t))return o;return null}(this.posts,e),o="boards.4chan.org"===location.hostname;return t?document.getElementById(o?"pc":"p"+t):null}isEmpty(){for(const e in this.posts)if(Object.prototype.hasOwnProperty.call(this.posts,e))return!1;return!0}};document.addEventListener("DOMContentLoaded",(()=>{const e=t.dialog?.node?.querySelector(".move"),o=t.dialog?.node?.querySelector(".jump"),a=t.dialog?.node?.querySelector(".close");function s(e){if(t.dialog&&t.dialog.node)switch(e.type){case"mouseup":if(!t.dialog.node.classList.contains("dragging"))return;let o;switch(t.dialog.node.classList.remove("dragging"),document.removeEventListener("mousemove",n),location.hostname){case"boards.4chan.org":o="4chan Dialog Coordinates";break;case"warosu.org":o="Warosu Dialog Coordinates";break;default:return}GM_setValue(o,[t.dialog.node.style.top,t.dialog.node.style.right,t.dialog.node.style.bottom,t.dialog.node.style.left]);break;case"mousedown":if(0!==e.button)return;e.preventDefault();const a=t.dialog.node.getBoundingClientRect();t.dialog.size[0]=a.width,t.dialog.size[1]=a.height,t.dialog.cursorPos[0]=e.x-a.x,t.dialog.cursorPos[1]=e.y-a.y,document.getElementById("header-bar")&&(t.dialog.header[0]=document.getElementById("header-bar")?.getBoundingClientRect().y||0,t.dialog.header[1]=document.getElementById("header-bar")?.offsetHeight||0,t.dialog.header[2]=document.documentElement.classList.contains("fixed"),t.dialog.header[3]=document.documentElement.classList.contains("autohide")),t.dialog.node.classList.add("dragging"),document.addEventListener("mousemove",n)}}function n(e){if(!t.dialog||!t.dialog.node)return;e.preventDefault();const o=document.documentElement.clientWidth,a=document.documentElement.clientHeight,s=e.x-t.dialog.cursorPos[0],n=e.y-t.dialog.cursorPos[1],i=o-t.dialog.size[0];let l=0,d=a-t.dialog.size[1];if(document.getElementById("header-bar")){const e=t.dialog.header[2],o=t.dialog.header[3];e&&!o&&(t.dialog.header[0]<t.dialog.header[1]?l+=t.dialog.header[1]:d-=t.dialog.header[1])}n>d?(t.dialog.node.style.bottom="0px",t.dialog.node.style.removeProperty("top")):(t.dialog.node.style.top=n>l?100*n/a+"%":l+"px",t.dialog.node.style.removeProperty("bottom")),s>i?(t.dialog.node.style.right="0px",t.dialog.node.style.removeProperty("left")):(t.dialog.node.style.left=s>0?100*s/o+"%":"0px",t.dialog.node.style.removeProperty("right"))}e?.addEventListener("mousedown",s),o?.addEventListener("click",(()=>{t.findPost(t.track)?.scrollIntoView()})),a?.addEventListener("click",(()=>{t.dialog?.close()})),document.addEventListener("mouseup",s),t.dialog?.node?.querySelector("ul")?.addEventListener("click",(e=>{if(!t.player)return;if(!e.target||"A"!==e.target.tagName)return;const o=e.target.dataset.page||"0";t.player.cuePlaylist(t.toPages()[parseInt(o)])})),document.head.insertAdjacentHTML("beforeend","<style>#playlist-embed{position:fixed;padding:1px 4px 1px 4px}#playlist-embed.hide{display:none}#playlist-embed>div:first-child{display:flex}#playlist-embed ul,#playlist-embed li{margin:0;padding:0}#playlist-embed li{display:inline-block;list-style-type:none}#playlist-embed li:not(:only-of-type):not(:last-of-type)::after{content:'•';margin:0 0.25em}#playlist-embed .move{flex:1}#playlist-embed .jump{margin-top:-1px}#playlist-embed .close{margin-left:4px}"+("boards.4chan.org"===location.hostname?":root:not(.fourchan-xt) #shortcut-playlist .icon{height:15px;width:16px;margin-bottom:-3px;}":".dialog{background-color:var(--darker-background-color);border:1px solid var(--even-darker-background-color);box-shadow: 0 1px 2px rgba(0, 0, 0, .15);}#playlist-embed a{text-decoration:none;}#playlist-embed .move{cursor:move;}")+"</style>")})),document.addEventListener("4chanXInitFinished",(()=>{document.addEventListener("ThreadUpdate",(e=>{e.detail[404]||Promise.allSettled([new Promise(((o,a)=>{if(e.detail.newPosts.length<1)return a();const s=e.detail.newPosts.map((e=>{const t=e.split(".").pop()||"";return[t,document.getElementById("m"+t)?.innerHTML||""]}));t.checking=!0,t.parsePosts(s).then((e=>t.player?(e>0&&(t.mutated=!0),o()):a()))})),new Promise(((o,a)=>e.detail.deletedPosts.length<1?a():(e.detail.deletedPosts.forEach((e=>{const o=e.split(".").pop();o&&o in t.posts&&(delete t.posts[o],t.player&&(t.mutated=!0))})),o())))]).finally((()=>{t.mutated&&!t.playing&&t.updatePlayer()}))}))})),unsafeWindow.onYouTubeIframeAPIReady=()=>{t.player=new YT.Player("playlist",{width:"512",height:"288",playerVars:{fs:0,disablekb:1,modestbranding:1},events:{onReady:function(e){t.track="",t.playing=!1,t.mutated=!1;const o=t.toPages();t.dialog?.updateTabs(o.length);const a="boards.4chan.org"===location.hostname?"4chan Last Played":"Warosu Last Played",s=window.location.pathname.split("/").pop()||"",n=GM_getValue(a,{})[s]||void 0,i=n?o.find((e=>e.includes(n))):o[0];n&&i?e.target.cuePlaylist(i,i.indexOf(n)):e.target.cuePlaylist(o[0]);t.dialog?.node?.classList.remove("hide"),t.dialog?.toggle?.classList.remove("disabled")},onStateChange:function(e){if(0==e.data){const o=t.toPages(),a=o.findIndex((e=>e.includes(t.track)));a>-1&&a<o.length-1&&e.target.loadPlaylist(o[a+1])}else if(-1==e.data){const o="boards.4chan.org"===location.hostname?"4chan Last Played":"Warosu Last Played",a=GM_getValue(o,{});t.track=e.target.getVideoUrl().split("=").pop()||"";a[window.location.pathname.split("/").pop()||""]=t.track,GM_setValue(o,a),t.mutated&&t.updatePlayer()}t.playing=1==e.data||3==e.data},onError:function(e){let t="",o="";const a=e.target.getPlaylistIndex(),s=e.target.getPlaylist().length;switch(+e.data){case 5:case 100:case 101:case 150:a+1<s&&e.target.nextVideo();case 101:case 150:t="warning",o="The owner of the requested video does not allow it to be played in embedded players.";break;case 2:t="error",o="The request contains an invalid parameter value.";break;case 5:t="error",o="The requested content cannot be played in an HTML5 player.";break;case 100:t="warning",o="The video has been removed or marked as private."}const n="Error - Video #"+(a+1)+"\n"+o;document.dispatchEvent(new CustomEvent("CreateNotification",{detail:{type:t,content:n,lifetime:10}}))}}})};
